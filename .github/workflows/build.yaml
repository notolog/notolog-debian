# Debian Package Builder for Notolog Editor
# Build scripts and packaging for the Notolog Editor Debian release.
#
# Repository: https://github.com/notolog/notolog-debian
# License: MIT License
#
# SPDX-FileCopyrightText: 2025-2026 Vadim Bakhrenkov
# SPDX-License-Identifier: MIT

name: Build Debian Package

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: "Version override (e.g., v1.2.0). Leave empty for latest release."
        required: false
        default: ""
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  APP_GIT_REPOSITORY: "notolog/notolog-editor"
  APP_RELEASES_URL: "https://api.github.com/repos/notolog/notolog-editor/releases"
  PACKAGE_NAME: "notolog-editor"

jobs:
  build:
    runs-on: ubuntu-latest
    # Note: For arm64 builds, use self-hosted runners or QEMU emulation
    # See README.md for instructions

    steps:
      - name: Get system info
        run: |
          PLATFORM_ARCH=$(uname -m)
          echo "$PLATFORM_ARCH"
          echo "PLATFORM_ARCH=$PLATFORM_ARCH" >> $GITHUB_ENV
          uname -a

      - name: Determine package version
        run: |
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            VERSION="${{ github.event.inputs.version_override }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION=$(curl -s ${{ env.APP_RELEASES_URL }}/latest | grep tag_name | cut -d '"' -f 4)
          fi
          echo "Building version: $VERSION"

          # Extract upstream version (strip Debian revision suffix like -1ubuntu1)
          # Example: v1.2.0-1ubuntu1 -> v1.2.0
          UPSTREAM_VERSION=$(echo "$VERSION" | sed 's/-[0-9]\+ubuntu[0-9]\+$//')
          echo "Upstream version: $UPSTREAM_VERSION"

          echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "UPSTREAM_VERSION=$UPSTREAM_VERSION" >> $GITHUB_ENV

      - name: Checkout builder repository
        uses: actions/checkout@v4

      - name: Checkout project source into ./src (shallow clone)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.APP_GIT_REPOSITORY }}
          path: src
          fetch-tags: true
          ref: refs/tags/${{ env.UPSTREAM_VERSION }}
          fetch-depth: 1 # Shallow clone (no .git history)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python3 --version
          python3 -m pip install --upgrade pip
          pip install poetry-core build pyinstaller reuse

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential zlib1g-dev debhelper devscripts lintian
          # Optional: install all declared build dependencies from debian/control
          sudo apt-get build-dep . || true

      - name: Print working directory
        run: pwd

      - name: Show package version
        run: |
          echo "Building version: ${{ env.PACKAGE_VERSION }}"
          echo "Repository: ${{ env.APP_GIT_REPOSITORY }}"

      - name: Build Debian package
        run: |
          cd ./pyinstaller

          # Ensure scripts are executable
          chmod +x build.sh clean-build.sh

          # Run the main build script
          ./build.sh

          # Verify PIE hardening
          echo "üîç Verifying PIE hardening..."
          hardening-check ./dist/notolog || {
            echo "‚ùå PIE hardening check failed."
            exit 1
          }

          # Clean up PyInstaller build artifacts
          ./clean-build.sh

      - name: Check SPDX compliance on source tree
        run: |
          reuse download --all
          reuse lint || (echo '‚ùå SPDX compliance failed.' && exit 1)

      - name: Copy .deb, .buildinfo, and .changes files
        run: |
          # Move to the workspace parent directory
          cd ..
          echo "Working from: $(pwd)"

          DEST="${{ github.workspace }}/build/debian"
          rm -rf "$DEST"
          mkdir -p "$DEST"

          # Require .deb file
          # Alternatively: DEB_FILE=$(ls ../ | grep -E "^notolog_.*_amd64\.deb$")
          DEB_FILE=$(find . -maxdepth 1 -type f -name "notolog*.deb" | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "‚ùå No .deb file found. Cannot continue."
            exit 1
          fi
          cp "$DEB_FILE" "$DEST/"
          echo "‚úÖ Copied .deb: $DEB_FILE"

          # Optional files
          for EXT in buildinfo changes; do
            FILE=$(find . -maxdepth 1 -type f -name "notolog*.${EXT}" | head -n 1)
            if [ -n "$FILE" ]; then
              cp "$FILE" "$DEST/"
              echo "‚úÖ Copied .${EXT}: $FILE"
            else
              echo "‚ö†Ô∏è No .${EXT} file found."
            fi
          done

          # GitHub Actions steps do not persist the working directory between steps
          echo "üì¶ Final artifact contents:"
          ls -lh "$DEST"

      - name: Upload Debian package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: notolog-${{ env.PACKAGE_VERSION }}
          path: build/debian/*

      - name: Lint Debian package
        run: lintian build/debian/*.deb || true

      - name: Validate changelog
        run: dpkg-parsechangelog
